using UnityEngine;
using Photon.Pun;
using Photon.Realtime;
using UnityEngine.UI;


public class NetworkReconnectionManager : MonoBehaviourPunCallbacks
{
    [Header("UI References")]
    [Tooltip("Panel que se muestra cuando alguien se desconecta")]
    public GameObject reconnectionPanel;
    
    [Tooltip("Texto del mensaje principal")]
    public Text statusText;
    
    [Tooltip("Texto del countdown")]
    public Text timerText;
    
    [Tooltip("BotÃ³n para volver al menÃº (cuando timeout)")]
    public Button menuButton;
    
    [Header("Reconnection Settings")]
    [Tooltip("Tiempo mÃ¡ximo de espera para reconexiÃ³n (5 minutos = 300 segundos)")]
    public float maxWaitTime = 300f; // 5 minutos como pediste
    
    [Tooltip("Intervalo de intento de reconexiÃ³n automÃ¡tica (cada X segundos)")]
    public float retryInterval = 5f; // Cada 5 segundos intenta reconectar
    
    [Header("Debug")]
    public bool showDebugLogs = true;
    
    // Estado interno
    private float waitTimer = 0f;
    private float retryTimer = 0f;
    private bool isWaitingForReconnection = false;
    private bool isDisconnectedFromInternet = false;
    private string disconnectedPlayerName = "";
    private string lastRoomName = "";
    
    void Start()
    {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âœ¨ CONFIGURACIÃ“N CRÃTICA PARA RECONEXIÃ“N POR INTERNET
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // 1. Activar reconexiÃ³n automÃ¡tica
        PhotonNetwork.AutomaticallySyncScene = true;
        
        // 2. Configurar timeouts mÃ¡s largos para esperar reconexiÃ³n
        PhotonNetwork.NetworkingClient.LoadBalancingPeer.DisconnectTimeout = 10000; // 10 segundos
        
        // 3. Guardar nombre de sala actual
        if (PhotonNetwork.InRoom)
        {
            lastRoomName = PhotonNetwork.CurrentRoom.Name;
            if (showDebugLogs)
                Debug.Log($"ğŸ’¾ Sala guardada: {lastRoomName}");
        }
        
        // Ocultar panel inicialmente
        if (reconnectionPanel != null)
            reconnectionPanel.SetActive(false);
            
        // Configurar botÃ³n de menÃº
        if (menuButton != null)
        {
            menuButton.onClick.AddListener(OnMenuButtonClicked);
            menuButton.gameObject.SetActive(false); // Oculto al inicio
        }
        
        if (showDebugLogs)
        {
            Debug.Log("ğŸ”Œ NetworkReconnectionManager inicializado");
            Debug.Log($"â±ï¸ Tiempo mÃ¡ximo de espera: {maxWaitTime} segundos ({maxWaitTime/60f} minutos)");
            Debug.Log($"ğŸ”„ Intervalo de reintento: {retryInterval} segundos");
        }
    }
    
    void Update()
    {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LÃ“GICA DE COUNTDOWN Y REINTENTOS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        if (isWaitingForReconnection)
        {
            // Actualizar timer principal (usar unscaledDeltaTime porque el juego estÃ¡ pausado)
            waitTimer -= Time.unscaledDeltaTime;
            
            // Actualizar UI del countdown
            UpdateTimerUI();
            
            // Timer de reintentos automÃ¡ticos
            retryTimer -= Time.unscaledDeltaTime;
            
            if (retryTimer <= 0)
            {
                // Intentar reconectar automÃ¡ticamente
                AttemptReconnection();
                retryTimer = retryInterval; // Resetear para prÃ³ximo intento
            }
            
            // Verificar si se agotÃ³ el tiempo
            if (waitTimer <= 0)
            {
                OnReconnectionTimeout();
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DETECTAR SI PERDIMOS CONEXIÃ“N A INTERNET (YO MISMO)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        if (PhotonNetwork.InRoom && !PhotonNetwork.IsConnected)
        {
            // YO perdÃ­ conexiÃ³n (no el otro jugador)
            if (!isDisconnectedFromInternet)
            {
                OnILostConnection();
            }
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CALLBACK: OTRO JUGADOR SE DESCONECTÃ“
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public override void OnPlayerLeftRoom(Player otherPlayer)
    {
        disconnectedPlayerName = otherPlayer.NickName;
        
        if (showDebugLogs)
            Debug.LogWarning($"âš ï¸ {disconnectedPlayerName} se desconectÃ³ de la sala");
        
        // PAUSAR EL JUEGO
        Time.timeScale = 0f;
        
        // Mostrar UI de espera
        ShowWaitingUI($"{disconnectedPlayerName} perdiÃ³ la conexiÃ³n");
        
        // Iniciar countdown y reintentos
        StartWaitingForReconnection();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CALLBACK: JUGADOR REGRESÃ“ âœ…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public override void OnPlayerEnteredRoom(Player newPlayer)
    {
        if (isWaitingForReconnection)
        {
            if (showDebugLogs)
                Debug.Log($"âœ… {newPlayer.NickName} SE RECONECTÃ“!");
            
            // REANUDAR JUEGO
            Time.timeScale = 1f;
            
            // Ocultar UI
            HideReconnectionUI();
            
            // Mostrar mensaje de bienvenida
            ShowTemporaryMessage($"âœ… {newPlayer.NickName} volviÃ³ al juego", Color.green);
            
            // Resetear estado
            isWaitingForReconnection = false;
            isDisconnectedFromInternet = false;
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CALLBACK: YO ME DESCONECTÃ‰ DEL MASTER SERVER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public override void OnDisconnected(DisconnectCause cause)
    {
        if (showDebugLogs)
            Debug.LogWarning($"âš ï¸ Desconectado del servidor. Causa: {cause}");
        
        // âœ¨ SOLUCIÃ“N: Capturar TODAS las causas de desconexiÃ³n de red
        // Esto incluye: pÃ©rdida de WiFi, router desconectado, cable ethernet desconectado
        if (cause == DisconnectCause.DisconnectByClientLogic ||
            cause == DisconnectCause.DisconnectByServerLogic ||
            cause == DisconnectCause.Exception ||
            cause == DisconnectCause.ExceptionOnConnect ||
            cause == DisconnectCause.ServerTimeout ||
            cause == DisconnectCause.ClientTimeout)
        {
            OnILostConnection();
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CALLBACK: ME RECONECTÃ‰ AL MASTER SERVER âœ…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public override void OnConnectedToMaster()
    {
        if (isDisconnectedFromInternet && !string.IsNullOrEmpty(lastRoomName))
        {
            if (showDebugLogs)
                Debug.Log($"âœ… Reconectado al Master Server. Intentando volver a sala: {lastRoomName}");
            
            // Intentar volver a la sala anterior
            PhotonNetwork.RejoinRoom(lastRoomName);
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CALLBACK: VOLVÃ A ENTRAR A LA SALA âœ…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    public override void OnJoinedRoom()
    {
        // âœ¨ SIEMPRE guardar nombre de sala cuando entramos
        lastRoomName = PhotonNetwork.CurrentRoom.Name;
        
        if (showDebugLogs)
            Debug.Log($"ğŸ’¾ Sala guardada: {lastRoomName}");
        
        // Si acabamos de reconectar
        if (isDisconnectedFromInternet)
        {
            if (showDebugLogs)
                Debug.Log($"âœ… Â¡RECONEXIÃ“N EXITOSA! VolvÃ­ a la sala: {PhotonNetwork.CurrentRoom.Name}");
            
            // Reanudar juego
            Time.timeScale = 1f;
            
            // Ocultar UI
            HideReconnectionUI();
            
            // Mostrar mensaje de Ã©xito
            ShowTemporaryMessage("âœ… Â¡ReconexiÃ³n exitosa!", Color.green);
            
            // Resetear estado
            isWaitingForReconnection = false;
            isDisconnectedFromInternet = false;
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // YO PERDÃ LA CONEXIÃ“N A INTERNET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void OnILostConnection()
    {
        isDisconnectedFromInternet = true;
        
        if (showDebugLogs)
            Debug.LogWarning("âš ï¸ YO perdÃ­ la conexiÃ³n a internet");
        
        // PAUSAR JUEGO
        Time.timeScale = 0f;
        
        // Mostrar UI
        ShowWaitingUI("Perdiste la conexiÃ³n a internet");
        
        // Iniciar countdown
        StartWaitingForReconnection();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INICIAR PROCESO DE ESPERA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void StartWaitingForReconnection()
    {
        isWaitingForReconnection = true;
        waitTimer = maxWaitTime;
        retryTimer = retryInterval;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INTENTAR RECONEXIÃ“N AUTOMÃTICA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void AttemptReconnection()
    {
        if (showDebugLogs)
            Debug.Log("ğŸ”„ Intentando reconectar...");
        
        if (!PhotonNetwork.IsConnected)
        {
            // Si no estamos conectados, intentar reconectar
            PhotonNetwork.ReconnectAndRejoin();
        }
        else if (PhotonNetwork.InRoom)
        {
            // Ya estamos en sala, verificar si el otro jugador regresÃ³
            if (PhotonNetwork.CurrentRoom.PlayerCount == 2)
            {
                // Â¡Ambos jugadores estÃ¡n de vuelta!
                if (showDebugLogs)
                    Debug.Log("âœ… Â¡Ambos jugadores reconectados!");
                
                Time.timeScale = 1f;
                HideReconnectionUI();
                isWaitingForReconnection = false;
                isDisconnectedFromInternet = false;
            }
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TIMEOUT - SE AGOTÃ“ EL TIEMPO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void OnReconnectionTimeout()
    {
        isWaitingForReconnection = false;
        
        if (showDebugLogs)
            Debug.LogError("âŒ Tiempo de reconexiÃ³n agotado (5 minutos)");
        
        if (statusText != null)
        {
            statusText.text = "âŒ No se pudo reconectar\n\n" +
                             "Tiempo de espera agotado (5 minutos)\n\n" +
                             "Â¿Volver al menÃº principal?";
        }
        
        // Mostrar botÃ³n de menÃº
        if (menuButton != null)
            menuButton.gameObject.SetActive(true);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI: MOSTRAR PANEL DE ESPERA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void ShowWaitingUI(string reason)
    {
        if (reconnectionPanel != null)
        {
            reconnectionPanel.SetActive(true);
            
            if (statusText != null)
            {
                statusText.text = $"âš ï¸ {reason}\n\n" +
                                 $"Esperando reconexiÃ³n...\n\n" +
                                 $"(El juego se reanudarÃ¡ automÃ¡ticamente)";
            }
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI: ACTUALIZAR COUNTDOWN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void UpdateTimerUI()
    {
        if (timerText != null)
        {
            int minutes = Mathf.FloorToInt(waitTimer / 60f);
            int seconds = Mathf.FloorToInt(waitTimer % 60f);
            
            timerText.text = $"â±ï¸ {minutes:00}:{seconds:00}";
            
            // Cambiar color segÃºn tiempo restante
            if (waitTimer <= 30)
                timerText.color = Color.red;
            else if (waitTimer <= 60)
                timerText.color = Color.yellow;
            else
                timerText.color = Color.white;
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI: OCULTAR PANEL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void HideReconnectionUI()
    {
        if (reconnectionPanel != null)
            reconnectionPanel.SetActive(false);
            
        if (menuButton != null)
            menuButton.gameObject.SetActive(false);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI: MENSAJE TEMPORAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void ShowTemporaryMessage(string message, Color color)
    {
        if (showDebugLogs)
            Debug.Log($"ğŸ“¢ {message}");
        
        // TODO: Crear UI temporal para mostrar mensaje 3 segundos
        // Por ahora solo log en consola
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BOTÃ“N: VOLVER AL MENÃš
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void OnMenuButtonClicked()
    {
        if (showDebugLogs)
            Debug.Log("ğŸšª Volviendo al menÃº principal...");
        
        // Reanudar tiempo
        Time.timeScale = 1f;
        
        // Desconectar de Photon
        PhotonNetwork.LeaveRoom();
        PhotonNetwork.Disconnect();
        
        // Cargar escena de menÃº
        UnityEngine.SceneManagement.SceneManager.LoadScene("MainMenu");
    }
}
